<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="./output.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://kit.fontawesome.com/f61c7f8567.js" crossorigin="anonymous"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Archivo:ital,wght@0,100..900;1,100..900&family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Geist+Mono:wght@100..900&family=IBM+Plex+Sans:ital,wght@0,100..700;1,100..700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="subtravelpackage.css">
    <link rel="stylesheet" href="flights.css">
    <script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="schema.js"></script>
    <link rel="stylesheet" href="booking-history.css">
    <title>My Trips - Booking History</title>
</head>

<body class="pizza-unicorn-wrapper">
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navcontents">
            <div class="navcontents-left">
                <div class="logo">
                    <a href="./index.html"><img src="assets/japa-logo.svg" alt="Logo" class="logo-img"></a>
                </div>

                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="#who-we-are">Who we are</a></li>
                    <li><a href="#how-to-japa">How to JAPA</a></li>
                    <li><a href="#featured-picks">Our Featured Picks</a></li>
                    <li><a href="#why-us">Why us</a></li>
                    <li style="font-weight: 600; color: #E71D36;">
                        <a href="./travel-packages.html" class="book-link">BOOK A PACKAGE</a>
                        <div class="confetti-container"></div>
                    </li>

                </ul>
            </div>

            <div class="user-actions">
                <div class="bookmark-container" id="bookmark-btn">
                    <svg class="bookmark-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
                    </svg>
                    Bookmarked trips
                    <span class="bookmark-badge" id="bookmark-count"></span>
                </div>

                <button id="username" class="login-button">
                    <a href="user-auth.html">Log In</a>
                </button>
            </div>
        </div>
    </nav>

    <div class="taco-bell-container">
        <!-- Header Section -->
        <header class="dancing-llama-header">
            <h1 class="magical-narwhal-title">My Trips</h1>
            <p class="sleepy-koala-subtitle">Track your travel adventures and plan your next journey</p>
        </header>

        <!-- Search and Filter Controls -->
        <div class="clever-monkey-controls">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search trips...">
            </div>
            <div class="filter-dropdown">
                <nav class="bouncy-giraffe-tabs">
                    <button class="tab-button active" data-tab="upcoming">
                        <i class="fas fa-calendar-plus"></i>
                        Upcoming Trips
                    </button>
                    <button class="tab-button" data-tab="history">
                        <i class="fas fa-history"></i>
                        Booking History
                    </button>
                </nav>
            </div>
        </div>

        <!-- Trips Content -->
        <main class="funky-elephant-trips">
            <!-- Upcoming Trips Tab -->
            <div id="upcoming-tab" class="tab-content active">
                <div id="trips-grid" class="trips-grid">
                    <!-- Automatically Injected from Firestore -->
                </div>
            </div>

            <!-- Booking History Tab -->
            <div id="history-tab" class="tab-content">
                <div id="past-trips-grid" class="trips-grid">
                    <!-- Injected Automatically from Firestore -->
                </div>
            </div>
        </main>

        <!-- Loading Skeletons -->
        <div class="loading-skeletons" id="loadingSkeletons">
            <div class="trip-skeleton">
                <div class="skeleton-content">
                    <div class="skeleton-image"></div>
                    <div class="skeleton-details">
                        <div class="skeleton-line medium"></div>
                        <div class="skeleton-line short"></div>
                        <div class="skeleton-line long"></div>
                    </div>
                </div>
            </div>
            <div class="trip-skeleton">
                <div class="skeleton-content">
                    <div class="skeleton-image"></div>
                    <div class="skeleton-details">
                        <div class="skeleton-line medium"></div>
                        <div class="skeleton-line short"></div>
                        <div class="skeleton-line long"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCpzXbFwpeHOBprUTFnvxp-0NvSjlIeuRg",
            authDomain: "japa-269a4.firebaseapp.com",
            projectId: "japa-269a4",
            storageBucket: "japa-269a4.firebasestorage.app",
            messagingSenderId: "736749113389",
            appId: "1:736749113389:web:886266a10a7b32f5ae28a4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables to store trip data
        let allTrips = [];
        let upcomingTrips = [];
        let pastTrips = [];
        let currentUser = null;

        function displayNav() {
            let savedItems = JSON.parse(localStorage.getItem('savedItems') || '[]');
            let bookmarkCount = document.getElementById('bookmark-count')

            function updateBookmarkCount() {
                savedItems = JSON.parse(localStorage.getItem('savedItems') || '[]');
                bookmarkCount.innerHTML = savedItems.length;
            }

            updateBookmarkCount();
            document.getElementById('bookmark-btn').addEventListener('click', () => {
                window.location.href = 'favorite-travel-packages.html'
            })
        }
        displayNav()

        function showLoading() {
            document.querySelector('.funky-elephant-trips').style.display = 'none';
            document.getElementById('loadingSkeletons').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingSkeletons').style.display = 'none';
            document.querySelector('.funky-elephant-trips').style.display = 'block';
        }

        // Fetch trips from Firestore
        async function fetchTripsFromFirestore() {
            try {
                if (!currentUser) {
                    console.log("No authenticated user");
                    return;
                }

                showLoading();
                console.log("Fetching trips for user:", currentUser.uid);

                const userDoc = await db.collection("users").doc(currentUser.uid).get();

                if (userDoc.exists) {
                    const userData = userDoc.data();
                    console.log("User data from Firestore:", userData);

                    // Get all trips and filter by date
                    allTrips = userData.upcomingTrips || [];
                    console.log("All trips from Firestore:", allTrips);

                    // Filter trips by date
                    filterTripsByDate();

                    // Render both upcoming and past trips
                    renderUpcomingTrips();
                    renderPastTrips();

                } else {
                    console.log("No user document found");
                    allTrips = [];
                    upcomingTrips = [];
                    pastTrips = [];
                    renderEmptyState();
                }

                hideLoading();

            } catch (error) {
                console.error("Error fetching trips from Firestore:", error);
                hideLoading();
                renderErrorState();
            }
        }

        function parseDate(dateString) {
            if (!dateString) return null;

            if (dateString.includes('-')) {
                return new Date(dateString);
            } else {
                return new Date(dateString);
            }
        }

        function filterTripsByDate() {
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);

            upcomingTrips = [];
            pastTrips = [];

            allTrips.forEach((trip, index) => {
                console.log(`Processing trip ${index}:`, trip);

                if (!trip.endDate) {
                    console.warn(`Trip ${index} missing endDate:`, trip);
                    // Default to upcoming if no end date
                    upcomingTrips.push(trip);
                    return;
                }

                const endDate = parseDate(trip.endDate);
                if (!endDate) {
                    upcomingTrips.push(trip);
                    return;
                }

                endDate.setHours(23, 59, 59, 999);

                console.log(`Trip ${index} end date:`, endDate, "Current:", currentDate, "Is past:", endDate < currentDate);

                if (endDate < currentDate) {
                    pastTrips.push(trip);
                } else {
                    upcomingTrips.push(trip);
                }
            });

            console.log("Filtered results - Upcoming:", upcomingTrips.length, "Past:", pastTrips.length);
        }

        // Enhanced Receipt Download Function with Better Error Handling

        function renderUpcomingTrips() {
            console.log("Rendering upcoming trips:", upcomingTrips);

            const tripsGrid = document.getElementById("trips-grid");
            if (!tripsGrid) {
                console.error("trips-grid element not found");
                return;
            }

            if (upcomingTrips.length === 0) {
                tripsGrid.innerHTML = '<div class="no-trips">No upcoming trips found.</div>';
                return;
            }

            // Generate HTML for each trip with unique identifiers
            const tripsHTML = upcomingTrips.map((trip, index) => {
                console.log(`Rendering upcoming trip ${index}:`, trip);
                return `
            <div class="groovy-penguin-card" data-trip-index="${index}">
                <div class="card-content">
                    <img src="${trip.tripThumbnail || trip.image || 'https://via.placeholder.com/300x200?text=Trip+Image'}" alt="${trip.destination}" class="trip-image">
                    <div class="trip-details">
                        <div class="trip-header">
                            <h3 class="trip-destination">${trip.destination || 'Destination'}</h3>
                            <span class="trip-status status-upcoming">Upcoming</span>
                        </div>
                        <p class="trip-dates">${trip.startDate || 'Start Date'} - ${trip.endDate || 'End Date'}</p>
                        <p class="trip-package">${trip.packageName || trip.name || 'Package Name'}</p>
                        <div class="trip-meta">
                            <span class="trip-price">${trip.totalAmtPaid || trip.price || 'Price N/A'}</span>
                            <div class="trip-actions">
                                <button class="download-receipt-btn" data-trip-index="${index}">
                                    <span class="btn-text">Download Receipt</span>
                                    <span class="btn-loading" style="display: none;">Generating...</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
            });

            tripsGrid.innerHTML = tripsHTML.join('');

            // Setup event listeners after DOM is ready
            setTimeout(() => {
                setupReceiptDownloadListeners();
            }, 100);
        }

        function setupReceiptDownloadListeners() {
            // Remove existing listeners to prevent duplicates
            document.querySelectorAll('.download-receipt-btn').forEach(button => {
                // Clone to remove all existing event listeners
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);

                // Add fresh event listener
                newButton.addEventListener('click', handleReceiptDownload);
            });
        }

        async function handleReceiptDownload(event) {
            const button = event.currentTarget;
            const tripIndex = parseInt(button.getAttribute('data-trip-index'));

            console.log('Download button clicked for trip index:', tripIndex);

            if (isNaN(tripIndex) || tripIndex < 0 || tripIndex >= upcomingTrips.length) {
                console.error('Invalid trip index:', tripIndex);
                showErrorMessage('Trip data not found. Please refresh the page and try again.');
                return;
            }

            const trip = upcomingTrips[tripIndex];
            console.log('Trip data for receipt:', trip);

            // Show loading state
            setButtonLoading(button, true);

            try {
                await generateReceipt(trip);
                showSuccessMessage('Receipt downloaded successfully!');
            } catch (error) {
                console.error('Error in handleReceiptDownload:', error);
                showErrorMessage('Failed to generate receipt. Please try again.');
            } finally {
                setButtonLoading(button, false);
            }
        }

        function setButtonLoading(button, isLoading) {
            const textSpan = button.querySelector('.btn-text');
            const loadingSpan = button.querySelector('.btn-loading');

            if (isLoading) {
                textSpan.style.display = 'none';
                loadingSpan.style.display = 'inline';
                button.disabled = true;
            } else {
                textSpan.style.display = 'inline';
                loadingSpan.style.display = 'none';
                button.disabled = false;
            }
        }

        async function generateReceipt(trip) {
            console.log('Starting PDF generation for trip:', trip);

            // Step 1: Check if jsPDF is available
            if (typeof window.jspdf === 'undefined') {
                console.error('jsPDF not found in window.jspdf');

                // Try alternative global access
                if (typeof jsPDF !== 'undefined') {
                    window.jspdf = { jsPDF };
                    console.log('Found jsPDF in global scope, assigned to window.jspdf');
                } else {
                    throw new Error('jsPDF library is not loaded. Please refresh the page and try again.');
                }
            }

            let doc;
            try {
                // Step 2: Initialize jsPDF
                const { jsPDF } = window.jspdf;
                doc = new jsPDF();
                console.log('jsPDF document created successfully');

            } catch (error) {
                console.error('Error creating jsPDF document:', error);
                throw new Error('Failed to initialize PDF generator. Please refresh the page.');
            }

            try {
                // Step 3: Generate PDF content
                console.log('Adding content to PDF...');

                // Set background
                doc.setFillColor(255, 255, 255);
                doc.rect(0, 0, doc.internal.pageSize.width, doc.internal.pageSize.height, 'F');

                // Add content with error handling for each step
                addPDFHeader(doc);
                addPDFContent(doc, trip);
                addPDFFooter(doc);

                // Step 4: Generate filename
                const filename = generateFileName(trip);
                console.log('Generated filename:', filename);

                // Step 5: Save the PDF
                doc.save(filename);
                console.log('PDF saved successfully');

            } catch (error) {
                console.error('Error generating PDF content:', error);
                throw new Error('Failed to create PDF content. Please try again.');
            }
        }

        function addPDFHeader(doc) {
            try {
                // Company name
                doc.setFontSize(18);
                doc.setTextColor(35, 31, 32);
                doc.text("JAPA TRAVEL", doc.internal.pageSize.width / 2, 25, { align: "center" });

                // Receipt title
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text("BOOKING RECEIPT", doc.internal.pageSize.width / 2, 35, { align: "center" });

                // Horizontal line
                doc.setLineWidth(0.3);
                doc.line(20, 40, doc.internal.pageSize.width - 20, 40);

            } catch (error) {
                console.error('Error adding PDF header:', error);
                // Continue without header rather than failing completely
            }
        }

        function addPDFContent(doc, trip) {
            let yPos = 55;
            const lineHeight = 10;

            try {
                // Receipt information
                const receiptData = [
                    ['Receipt Date:', formatCurrentDate()],
                    ['Booking ID:', trip.bookingId || generateBookingId()],
                    ['Customer:', sanitizeText(trip.travelerName || currentUser?.displayName || 'Guest')],
                    ['', ''], // Spacer
                    ['Package:', sanitizeText(trip.packageName || trip.name || 'Travel Package')],
                    ['Destination:', sanitizeText(trip.destination || 'Not specified')],
                    ['Start Date:', sanitizeText(trip.startDate || 'TBD')],
                    ['End Date:', sanitizeText(trip.endDate || 'TBD')],
                    ['Travelers:', sanitizeText((trip.travelerNo || '1').toString())],
                    ['', ''], // Spacer
                    ['TOTAL PAID:', sanitizeText(trip.totalAmtPaid || trip.price || 'Contact for pricing')]
                ];

                receiptData.forEach(([label, value]) => {
                    if (label && value) {
                        doc.setFontSize(10);
                        doc.setTextColor(60, 60, 60);
                        doc.text(label, 25, yPos);

                        // Make total amount bold
                        if (label === 'TOTAL PAID:') {
                            doc.setFontSize(12);
                            doc.setTextColor(231, 29, 54);
                        }

                        doc.text(value, 70, yPos);
                    }
                    yPos += lineHeight;
                });

            } catch (error) {
                console.error('Error adding PDF content:', error);
                // Add fallback content
                doc.setFontSize(10);
                doc.setTextColor(60, 60, 60);
                doc.text('Receipt data temporarily unavailable', 25, yPos);
            }
        }

        function addPDFFooter(doc) {
            try {
                const pageHeight = doc.internal.pageSize.height;
                let footerY = pageHeight - 40;

                doc.setFontSize(9);
                doc.setTextColor(120, 120, 120);
                doc.text("Thank you for choosing JAPA Travel!", doc.internal.pageSize.width / 2, footerY, { align: "center" });

                footerY += 8;
                doc.setFontSize(8);
                doc.text("Contact: support@japatravel.com", doc.internal.pageSize.width / 2, footerY, { align: "center" });

            } catch (error) {
                console.error('Error adding PDF footer:', error);
                // Continue without footer
            }
        }

        // Utility functions
        function sanitizeText(text) {
            if (!text) return 'N/A';
            return String(text).replace(/[^\w\s\-.,()$]/g, '').substring(0, 50);
        }

        function formatCurrentDate() {
            return new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function generateBookingId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = 'JP';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function generateFileName(trip) {
            const date = new Date().toISOString().slice(0, 10);
            const destination = (trip.destination || 'Trip').replace(/[^a-zA-Z0-9]/g, '').substring(0, 15);
            const bookingId = (trip.bookingId || generateBookingId()).replace(/[^a-zA-Z0-9]/g, '');
            return `JAPA_${destination}_${bookingId}_${date}.pdf`;
        }

        function showSuccessMessage(message) {
            showMessage(message, 'success');
        }

        function showErrorMessage(message) {
            showMessage(message, 'error');
        }

        function showMessage(message, type) {
            // Remove any existing notifications
            document.querySelectorAll('.notification').forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            const bgColor = type === 'success' ? '#28a745' : '#dc3545';
            notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${bgColor};
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 14px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        max-width: 300px;
        word-wrap: break-word;
    `;

            document.body.appendChild(notification);

            // Remove after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    notification.style.transition = 'all 0.3s ease';
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }
            }, 4000);
        }

        // Diagnostic functions for debugging
        window.testJsPDF = function () {
            console.log('Testing jsPDF availability...');
            console.log('window.jspdf:', typeof window.jspdf);
            console.log('global jsPDF:', typeof jsPDF);

            if (window.jspdf) {
                try {
                    const { jsPDF } = window.jspdf;
                    const testDoc = new jsPDF();
                    console.log('‚úÖ jsPDF is working correctly');
                    return true;
                } catch (error) {
                    console.error('‚ùå jsPDF failed:', error);
                    return false;
                }
            } else {
                console.error('‚ùå jsPDF not available');
                return false;
            }
        };

        window.testReceiptGeneration = async function () {
            const testTrip = {
                destination: "Test Destination",
                packageName: "Test Package",
                startDate: "2025-01-01",
                endDate: "2025-01-07",
                totalAmtPaid: "$1,000",
                travelerName: "Test User"
            };

            try {
                await generateReceipt(testTrip);
                console.log('‚úÖ Test receipt generated successfully');
            } catch (error) {
                console.error('‚ùå Test receipt failed:', error);
            }
        };

        // Add enhanced CSS for buttons
        const enhancedStyles = document.createElement('style');
        enhancedStyles.textContent = `
    .download-receipt-btn {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s ease;
        position: relative;
        min-width: 140px;
    }
    
    .download-receipt-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, #0056b3, #004085);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,123,255,0.3);
    }
    
    .download-receipt-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .download-receipt-btn .btn-loading {
        display: inline-block;
    }
    
    .notification {
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
`;
        document.head.appendChild(enhancedStyles);
        function renderPastTrips() {
            console.log("Rendering past trips:", pastTrips);

            const pastTripsGrid = document.getElementById("past-trips-grid");
            if (!pastTripsGrid) {
                console.error("past-trips-grid element not found");
                return;
            }

            if (pastTrips.length === 0) {
                pastTripsGrid.innerHTML = '<div class="no-trips">No past trips found.</div>';
                return;
            }

            const tripsHTML = pastTrips.map((trip, i) => {
                console.log(`Rendering past trip ${i}:`, trip);
                return `
                    <div class="groovy-penguin-card">
                        <div class="card-content">
                            <img src="${trip.tripThumbnail || trip.image || 'https://via.placeholder.com/300x200?text=Trip+Image'}" alt="${trip.destination}" class="trip-image">
                            <div class="trip-details">
                                <div class="trip-header">
                                    <h3 class="trip-destination">${trip.destination || 'Destination'}</h3>
                                    <span class="trip-status status-completed">Completed</span>
                                </div>
                                <p class="trip-dates">${trip.startDate || 'Start Date'} - ${trip.endDate || 'End Date'}</p>
                                <p class="trip-package">${trip.packageName || trip.name || 'Package Name'}</p>
                                <div class="trip-meta">
                                    <span class="trip-price">${trip.totalAmtPaid || trip.price || 'Price N/A'}</span>
                                    <div class="trip-actions">
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            pastTripsGrid.innerHTML = tripsHTML.join('');
        }

        function renderEmptyState() {
            document.getElementById("trips-grid").innerHTML = '<div class="no-trips">No trips found. Start planning your next adventure!</div>';
            document.getElementById("past-trips-grid").innerHTML = '<div class="no-trips">No past trips found.</div>';
        }

        function renderErrorState() {
            const errorMessage = '<div class="no-trips">Error loading trips. Please try again later.</div>';
            document.getElementById("trips-grid").innerHTML = errorMessage;
            document.getElementById("past-trips-grid").innerHTML = errorMessage;
        }

        function myFirebaseUserAuth() {
            firebase.auth().onAuthStateChanged(async (user) => {
                const usernameElement = document.getElementById("username");
                currentUser = user;

                if (user) {
                    console.log("Current user:", user);
                    const displayName = user.displayName || user.email;
                    const firstInitial = displayName.charAt(0).toUpperCase();

                    usernameElement.innerHTML = `
                        <div class="user-profile-container">
                            <div class="profile-picture" id="profilePicture">
                                <span class="profile-initial">${firstInitial}</span>
                            </div>
                            <div class="profile-dropdown" id="profileDropdown">
                                <div class="dropdown-header">
                                    <div class="dropdown-profile-pic">
                                        <span class="dropdown-initial">${firstInitial}</span>
                                    </div>
                                    <div class="dropdown-user-info">
                                        <div class="dropdown-name">üëãüèΩ Hello, ${user.displayName || 'there'}!</div>
                                        <div class="dropdown-email">${user.email}</div>
                                    </div>
                                </div>
                                <hr class="dropdown-divider">
                                <button class="dropdown-item" id="route-to-trips">
                                    <svg class="logout-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z" fill="currentColor"/>
                                    </svg>
                                    My Upcoming Trips
                                </button>
                                <hr class="dropdown-divider">
                                <button class="dropdown-item" id="logoutBtn">
                                    <svg class="logout-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <polyline points="16,17 21,12 16,7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <line x1="21" y1="12" x2="9" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Log Out
                                </button>
                            </div>
                        </div>
                    `;

                    usernameElement.className = "user-profile";

                    // Fetch trips from Firestore once user is authenticated
                    await fetchTripsFromFirestore();

                } else {
                    console.log("No user signed in.");
                    currentUser = null;
                    usernameElement.innerHTML = '<a href="user-auth.html">Log In</a>';
                    usernameElement.className = "login-button";
                    renderEmptyState();
                }
            });

            function toggleDropdown() {
                const dropdown = document.getElementById("profileDropdown");
                if (dropdown) {
                    dropdown.classList.toggle("show");
                }
            }

            document.addEventListener('click', function (event) {
                const userProfile = document.querySelector('.user-profile-container');
                const dropdown = document.getElementById("profileDropdown");

                if (userProfile && !userProfile.contains(event.target)) {
                    dropdown?.classList.remove("show");
                }
            });

            function handleLogout() {
                firebase.auth().signOut().then(() => {
                    console.log("User signed out successfully");
                    window.location.reload();
                }).catch((error) => {
                    console.error("Error signing out:", error);
                });
            }

            function handleUpcomingTripsRoute() {
                window.location.href = './bookinghistory.html'
            }

            document.addEventListener('DOMContentLoaded', function () {
                document.addEventListener('click', function (event) {
                    if (event.target.closest('#logoutBtn')) {
                        handleLogout();
                    }
                    if (event.target.closest('#route-to-trips')) {
                        handleUpcomingTripsRoute();
                    }
                    if (event.target.closest('#profilePicture')) {
                        toggleDropdown();
                    }
                });
            });
        }

        // Tab Switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                button.classList.add('active');

                const tabName = button.getAttribute('data-tab');
                const targetTab = document.getElementById(tabName + '-tab');
                if (targetTab) {
                    targetTab.classList.add('active');
                }
            });
        });

        // Search functionality
        document.querySelector('.search-input').addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase();
            const tripCards = document.querySelectorAll('.groovy-penguin-card');

            tripCards.forEach(card => {
                const destinationEl = card.querySelector('.trip-destination');
                const packageEl = card.querySelector('.trip-package');

                if (destinationEl && packageEl) {
                    const destination = destinationEl.textContent.toLowerCase();
                    const packageName = packageEl.textContent.toLowerCase();

                    if (destination.includes(searchTerm) || packageName.includes(searchTerm)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
        });

        // Initialize authentication
        myFirebaseUserAuth();

        // Utility functions for debugging
        window.refreshTrips = async function () {
            console.log("Manually refreshing trips...");
            await fetchTripsFromFirestore();
        };

        window.checkFirebaseAuth = function () {
            console.log("Current user:", firebase.auth().currentUser);
            console.log("Current user variable:", currentUser);
        };

        window.addSampleTrip = async function () {
            if (!currentUser) {
                console.log("No authenticated user");
                return;
            }

            const sampleTrip = {
                destination: "Tokyo, Japan",
                packageName: "Japan Cultural Experience",
                startDate: "2025-09-10",
                endDate: "2025-09-17",
                totalAmtPaid: "$3,200",
                tripThumbnail: "https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=300&h=200&fit=crop"
            };

            try {
                // Add to the existing trips array
                const currentTrips = [...allTrips, sampleTrip];

                await db.collection("users").doc(currentUser.uid).set({
                    upcomingTrips: currentTrips,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                console.log("Sample trip added!");
                await fetchTripsFromFirestore();
            } catch (error) {
                console.error("Error adding sample trip:", error);
            }
        };
    </script>

    <style>
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .no-trips {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 2rem;
            background: #f9f9f9;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .loading-skeletons {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 2rem 0;
        }

        .trip-skeleton {
            background: #f0f0f0;
            border-radius: 12px;
            overflow: hidden;
            animation: pulse 2s infinite;
        }

        .skeleton-content {
            padding: 1rem;
        }

        .skeleton-image {
            width: 100%;
            height: 200px;
            background: #e0e0e0;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .skeleton-line {
            height: 16px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .skeleton-line.short {
            width: 60%;
        }

        .skeleton-line.medium {
            width: 80%;
        }

        .skeleton-line.long {
            width: 100%;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }
    </style>
</body>

</html>