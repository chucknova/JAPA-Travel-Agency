<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="./output.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://kit.fontawesome.com/f61c7f8567.js" crossorigin="anonymous"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Archivo:ital,wght@0,100..900;1,100..900&family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Geist+Mono:wght@100..900&family=IBM+Plex+Sans:ital,wght@0,100..700;1,100..700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="travel-package-payment-successful.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <title>Payment Successful || JAPA</title>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navcontents">
            <div class="navcontents-left">
                <div class="logo">
                    <a href="./index.html"><img src="assets/japa-logo.svg" alt="Logo" class="logo-img"></a>
                </div>

                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="#who-we-are">Who we are</a></li>
                    <li><a href="#how-to-japa">How to JAPA</a></li>
                    <li><a href="#featured-picks">Our Featured Picks</a></li>
                    <li><a href="#why-us">Why us</a></li>

                </ul>
            </div>

            <div class="user-actions">
                <button id="username" class="login-button">
                    <a href="user-auth.html">Log In</a>
                </button>
            </div>
        </div>
    </nav>

    <div id="success-container" class="success-container">
        <!-- Automatically Inserted from dom manipulation -->
    </div>

</body>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCpzXbFwpeHOBprUTFnvxp-0NvSjlIeuRg",
        authDomain: "japa-269a4.firebaseapp.com",
        projectId: "japa-269a4",
        storageBucket: "japa-269a4.firebasestorage.app",
        messagingSenderId: "736749113389",
        appId: "1:736749113389:web:886266a10a7b32f5ae28a4"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function displayNav() {
        let savedItems = JSON.parse(localStorage.getItem('savedItems') || '[]');
        let bookmarkCount = document.getElementById('bookmark-count')
        // Function to update bookmark count in navbar
        function updateBookmarkCount() {
            savedItems = JSON.parse(localStorage.getItem('savedItems') || '[]');
            if (bookmarkCount) {
                bookmarkCount.innerHTML = savedItems.length;
            }
        }

        // Initial count update
        updateBookmarkCount();
        const bookmarkBtn = document.getElementById('bookmark-btn');
        if (bookmarkBtn) {
            bookmarkBtn.addEventListener('click', () => {
                window.location.href = 'favorite-travel-packages.html'
            });
        }
    }
    displayNav()

    function myFirebaseUserAuth() {
        // Firebase Auth State Change Handler
        firebase.auth().onAuthStateChanged((user) => {
            const usernameElement = document.getElementById("username");

            if (user) {
                console.log("Current user:", user);

                // Get the first initial from display name or email
                const displayName = user.displayName || user.email;
                const firstInitial = displayName.charAt(0).toUpperCase();



                // Replace the button content with profile picture and dropdown
                usernameElement.innerHTML = `
                    <div class="user-profile-container">
        <div class="profile-picture" id="profilePicture">
            <span class="profile-initial">${firstInitial}</span>
        </div>
        <div class="profile-dropdown" id="profileDropdown">
            <div class="dropdown-header">
                <div class="dropdown-profile-pic">
                    <span class="dropdown-initial">${firstInitial}</span>
                </div>
                <div class="dropdown-user-info">
                    <div class="dropdown-name">üëãüèΩ Hello, there! ${user.displayName || 'Hello, there! üëãüèΩ'}</div>
                    <div class="dropdown-email">${user.email}</div>
                </div>
            </div>
            <hr class="dropdown-divider">
            <button class="dropdown-item" id="route-to-trips">
                <svg class="logout-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"
                        fill="currentColor" />
                </svg>
                My Upcoming Trips
            </button>
            <hr class="dropdown-divider">
            <button class="dropdown-item" id="bookmark-btn">
                <svg class="logout-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
                </svg>
                My Bookmarked Trips
            </button>
            <hr class="dropdown-divider">
            <button style = "color: red;" class="dropdown-item" id="logoutBtn">
                <svg class="logout-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="red" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" />
                    <polyline points="16,17 21,12 16,7" stroke="red" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <line x1="21" y1="12" x2="9" y2="12" stroke="red" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                Log Out
            </button>
        </div>
    </div>
    `;

                // Remove the login-button class and add user-profile class
                usernameElement.className = "user-profile";

            } else {
                console.log("No user signed in.");
                // Reset to login button
                usernameElement.innerHTML = '<a href="user-auth.html">Log In</a>';
                usernameElement.className = "login-button";
            }
        });

        // Toggle dropdown function
        function toggleDropdown() {
            const dropdown = document.getElementById("profileDropdown");
            dropdown.classList.toggle("show");
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const userProfile = document.querySelector('.user-profile-container');
            const dropdown = document.getElementById("profileDropdown");

            if (userProfile && !userProfile.contains(event.target)) {
                dropdown?.classList.remove("show");
            }
        });

        // Logout function with event listener
        function handleLogout() {
            firebase.auth().signOut().then(() => {
                console.log("User signed out successfully");
                // Redirect to home page or refresh
                window.location.reload();
            }).catch((error) => {
                console.error("Error signing out:", error);
            });
        }

        // Routing users to upcoming trips / booking history
        function handleUpcomingTripsRoute() {
            window.location.href = './bookinghistory.html'
        }

        // Routing users to bookmarks
        function handleBookmarks() {
            window.location.href = './favorite-travel-packages.html'
        }

        // Add event listener for logout button and profile picture
        document.addEventListener('DOMContentLoaded', function () {
            // Use event delegation since elements are dynamically created
            document.addEventListener('click', function (event) {
                // Handle logout button click
                if (event.target.closest('#logoutBtn')) {
                    handleLogout();
                }
                if (event.target.closest('#route-to-trips')) {
                    handleUpcomingTripsRoute();
                }
                if (event.target.closest('#bookmark-btn')) {
                    handleBookmarks();
                }

                // Handle profile picture click
                if (event.target.closest('#profilePicture')) {
                    toggleDropdown();
                }
            });
        });

    }
    myFirebaseUserAuth()

    const bookingID = new URLSearchParams(window.location.search).get('bookingID');
    const bookingSession = JSON.parse(sessionStorage.getItem('bookingSession') || '{}');

    console.log(bookingID);        // e.g. JPX251841
    console.log(bookingSession);   // Object with booking data

    const addBookingsToFirestore = async () => {
        // Get the current user
        const user = firebase.auth().currentUser;

        if (user) {
            try {
                // Get the user's document reference
                const userDocRef = db.collection('users').doc(user.uid);

                // Get the current user document
                const userDoc = await userDocRef.get();

                if (userDoc.exists) {
                    const userData = userDoc.data();

                    // Get existing upcomingTrips or initialize as empty array
                    const existingTrips = userData.upcomingTrips || [];

                    // Get the upcoming bookings from sessionStorage (since you mentioned it's from previous page)
                    const upcomingBookings = JSON.parse(sessionStorage.getItem('upcomingbookings') || '[]');

                    // Combine existing trips with new bookings
                    // You might want to check for duplicates based on your data structure
                    const updatedTrips = [...existingTrips, ...upcomingBookings];

                    // Update the user document with the new trips
                    await userDocRef.update({
                        upcomingTrips: updatedTrips
                    });

                    console.log('Successfully added upcoming bookings to user document');

                    // Optional: Clear sessionStorage after successful save
                    sessionStorage.removeItem('upcomingbookings');

                } else {
                    console.log('User document does not exist');
                    // Create user document with upcomingTrips if it doesn't exist
                    const upcomingBookings = JSON.parse(sessionStorage.getItem('upcomingbookings') || '[]');

                    await userDocRef.set({
                        upcomingTrips: upcomingBookings
                    }, { merge: true });
                }

            } catch (error) {
                console.error('Error updating user document:', error);
            }
        } else {
            console.log('No user is currently logged in');
        }
    };

    // Add authentication state listener before calling the function
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            addBookingsToFirestore();
        }
    });

    // Storing receipts
    // Step 1: Get existing receipts from localStorage or start fresh
    const receiptsDatabase = JSON.parse(localStorage.getItem("japaReceipts") || '{}');

    // Check if bookingSession has required data before proceeding
    if (bookingSession && Object.keys(bookingSession).length > 0) {
        // Step 2: Create a new receipt entry
        receiptsDatabase[bookingSession.bookingId] = {
            customer: bookingSession.travelerName || 'N/A',
            destination: bookingSession.destination || 'N/A',
            amountPaid: bookingSession.totalAmtPaid || 'N/A',
            date: bookingSession.bookingDate || new Date().toISOString().split('T')[0],
            bookingID: bookingSession.bookingId || bookingID,
            from: bookingSession.startDate || 'N/A',
            to: bookingSession.endDate || 'N/A'
        };

        // Step 3: Save the updated object back to localStorage
        localStorage.setItem("japaReceipts", JSON.stringify(receiptsDatabase));

        // Render the success page content
        document.getElementById('success-container').innerHTML = `
        <div class="left-message-cta">
                <img src="./assets/payment made!.gif" alt="" class="payment-made-animation" onerror="this.style.display='none'">
                <div class="confirmation-message-ps">
                    <h1>Woohoo! üéâ You're all set for ${bookingSession.destination || 'your destination'}. JAPA Successful</h1>
                    <p>Please download your receipt and check your upcoming bookings</p>
                </div>
               <div style="display: flex; flex-direction: row; gap: 8px;" class="button-flexx">
                <button id="routetoupcoming"
                    style="color: var(--Pink, #E71D36); border: 1px, solid, var(--Pink, #E71D36); background-color: var(--White, #FFF);">
                    My upcoming bookings</button>
                <button id="generateReceipt">Download Receipt here</button>
            </div>
            </div>

             <div id="trip-summary" class="right-trip-summary">
                <h2>Your Trip Summary</h2>
                <div class="trip-summary">
                    <div class="trip-summary-inner">
                        <!-- Trip Detail for Booking ID -->
                        <div class="trip-detail-booking-id">
                            <div class="trip-detail-booking-id-inner">
                                <h3>Booking ID</h3>
                                <div class="booking-id-badge">${bookingSession.bookingId || bookingID || 'N/A'}</div>
                            </div>
                        </div>

                        <!-- Trip Detail -->
                        <div class="trip-detail">
                            <div class="trip-detail-inner">
                                <h3>Destination</h3>
                                <h4>${bookingSession.destination || 'N/A'}</h4>
                            </div>
                        </div>

                        <!-- Trip Detail -->
                        <div class="trip-detail">
                            <div class="trip-detail-inner">
                                <h3>Travel Package Name</h3>
                                <h4>${bookingSession.packageName || 'N/A'}</h4>
                            </div>
                        </div>

                        <!-- Trip Detail -->
                        <div class="trip-detail">
                            <div class="trip-detail-inner">
                                <h3>Duration</h3>
                                <h4>${bookingSession.duration || 'N/A'} Days (${bookingSession.startDate || 'N/A'} - ${bookingSession.endDate || 'N/A'})</h4>
                            </div>
                        </div>

                        <!-- Trip Detail -->
                        <div class="trip-detail">
                            <div class="trip-detail-inner">
                                <h3>Number of Travelers</h3>
                                <h4>${bookingSession.travelerNo || 'N/A'}</h4>
                            </div>
                        </div>

                        <!-- Trip Detail -->
                        <div class="trip-detail">
                            <div class="trip-detail-inner">
                                <h3>Total Paid</h3>
                                <h4>${bookingSession.totalAmtPaid || 'N/A'}</h4>
                            </div>
                        </div>

                        <!-- Trip Detail -->
                        <div class="trip-detail">
                            <div class="trip-detail-inner">
                                <h3>Booking Date</h3>
                                <h4>${bookingSession.bookingDate || new Date().toLocaleDateString()}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add event listener for receipt generation
        const generateReceiptBtn = document.getElementById('generateReceipt');
        const routetoupcoming = document.getElementById('routetoupcoming');
        if (generateReceiptBtn) {
            generateReceiptBtn.addEventListener("click", async () => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // üé® Clean white background
                     doc.setFillColor(255, 255, 255);
                doc.rect(0, 0, doc.internal.pageSize.width, doc.internal.pageSize.height, 'F');


                    // üìÑ Title
                    doc.setFontSize(16);
                    doc.setFont("courier", "bold");
                    doc.setTextColor(0, 0, 0);
                    doc.text("JAPA TRAVEL", 105, 35, { align: "center" });

                    doc.setFontSize(10);
                    doc.setFont("courier", "normal");
                    doc.text("RECEIPT", 105, 45, { align: "center" });

                    // ‚úçüèΩ Booking details section
                    doc.setFontSize(12);
                    doc.setFont("courier", "normal");
                    doc.setTextColor(40, 40, 40);

                    // Format date nicely
                    const formattedDate = bookingSession.bookingDate ?
                        new Date(bookingSession.bookingDate).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        }) : new Date().toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });

                    // Receipt details with clean spacing
                    let yPos = 65;
                    const lineHeight = 10;

                    doc.text(`DATE:        ${formattedDate}`, 20, yPos);
                    yPos += lineHeight;

                    doc.text(`BOOKING ID:  ${bookingSession.bookingId || bookingID || 'N/A'}`, 20, yPos);
                    yPos += lineHeight;

                    doc.text(`CUSTOMER:    ${(bookingSession.travelerName || 'N/A').toUpperCase()}`, 20, yPos);
                    yPos += lineHeight;

                    doc.text(`PACKAGE BOOKED: ${(bookingSession.packageName || 'N/A').toUpperCase()}`, 20, yPos);
                    yPos += lineHeight * 2;

                    doc.text(`FROM: ${(bookingSession.startDate || 'N/A').toUpperCase()}`, 20, yPos);
                    yPos += lineHeight * 2;

                    doc.text(`TO: ${(bookingSession.endDate || 'N/A').toUpperCase()}`, 20, yPos);
                    yPos += lineHeight * 2;

                    doc.text(`DESTINATION: ${(bookingSession.destination || 'N/A').toUpperCase()}`, 20, yPos);
                    yPos += lineHeight * 2;

                    doc.text(`TRAVELER COUNT: ${bookingSession.travelerNo || 'N/A'}`, 20, yPos);
                    yPos += lineHeight * 2;

                    // Amount section 
                    doc.setFontSize(12);
                    doc.setFont("courier", "bold");
                    doc.text(`TOTAL PAID:  ${bookingSession.totalAmtPaid || 'N/A'}`, 20, yPos);
                    yPos += lineHeight * 2.5;

                    // thank you footer
                    doc.setFontSize(8);
                    doc.setFont("courier", "normal");
                    doc.setTextColor(80, 80, 80);
                    doc.text("THANK YOU FOR BOOKING WITH US!", 105, yPos, { align: "center" });
                    yPos += 10;

                    doc.setFontSize(7);
                    doc.setFont("courier", "normal");
                    doc.text("JAPA ‚Äî Making your travel dreams a reality.", 105, yPos, { align: "center" });
                    yPos += 15;

                    //  Contact info
                    doc.setFontSize(7);
                    doc.setFont("courier", "normal");
                    doc.setTextColor(120, 120, 120);
                    doc.text("support@japatravel.com | www.japatravel.com", 105, yPos, { align: "center" });

                    //  Save file with timestamp
                    const timestamp = new Date().toISOString().slice(0, 10);
                    const fileName = `japa_receipt_${(bookingSession.bookingId || bookingID || 'unknown').replace("#", "")}_${timestamp}.pdf`;
                    doc.save(fileName);
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating receipt. Please try again.');
                }
            });
        }
    } else {
        // Handle case where no booking session data is available
        document.getElementById('success-container').innerHTML = `
            <div class="left-message-cta">
                <div class="confirmation-message-ps">
                    <h1>Booking Information Not Found</h1>
                    <p>We couldn't retrieve your booking details. Please check your email for confirmation or contact support.</p>
                </div>
                <button onclick="window.location.href='./travel-packages.html'">Browse Travel Packages</button>
            </div>
        `;
    }

    routetoupcoming.addEventListener("click", function () {
        window.location.href = "./bookinghistory.html"
    })

    console.log("Receipts here:", receiptsDatabase);
</script>

</html>