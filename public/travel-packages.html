<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="./output.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://kit.fontawesome.com/f61c7f8567.js" crossorigin="anonymous"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Archivo:ital,wght@0,100..900;1,100..900&family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Geist+Mono:wght@100..900&family=IBM+Plex+Sans:ital,wght@0,100..700;1,100..700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="travelpackages.css">
    <link rel="stylesheet" href="flights.css">
    <script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-auth-compat.js"></script>
    <script src="schema.js"></script>
    <title>Travel Packages || JAPA</title>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navcontents">
            <div class="navcontents-left">
                <div class="logo">
                    <img src="assets/japa-logo.svg" alt="Logo" class="logo-img">
                </div>

                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="#who-we-are">Who we are</a></li>
                    <li><a href="#how-to-japa">How to JAPA</a></li>
                    <li><a href="#featured-picks">Our Featured Picks</a></li>
                    <li><a href="#why-us">Why us</a></li>

                </ul>
            </div>

            <div class="user-actions">
                <button id="username" class="login-button">
                    <a href="user-auth.html">Log In</a>
                </button>
            </div>
        </div>
    </nav>

    <!-- Hero -->
    <div class="hero-section-tp">
        <div class="hero-content-tp">
            <h1 class="hero-header-tp">Search vacation packages & trips</h1>
            <p class="hero-subtext-tp">Explore handpicked travel packages designed for every kind of traveler </p>
        </div>
    </div>

    <!-- Travel Package -->
    <div class="travel-packages">
        <div class="top">
            <div class="top-left">
                <h3 class="travel-package-top-left-header-tp"><b>Select any package category below.</b><p style="color: rgba(0, 0, 0, 0.5); padding-top: 4px;">Find Your Perfect Getaway</p></h3>
            </div>
        </div>

        <div class="bottom" id="bottom-container">

        </div>
    </div>

    <!-- How does JAPA work? -->
    <div class="how-japa-works">
        <div class="main-container">
            <div class="inner-container">
                <div class="bg-img"></div>
                <div class="left">
                    <div class="left-top">
                        <h3>How does JAPA work?</h3>
                        <p>1. Browse destinations and packages across the world.</p>
                        <p>2. Choose your dates and reserve in minutes‚Äîno stress.</p>
                        <p>3. Pack your bags, we handle the rest. Your Japa journey awaits.</p>
                    </div>
                    <div class="left-bottom">
                        <button>JAPA Today</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    // import travelPackages from "./travel-package-schema.js";
    // console.log(travelPackages);
    const travelPackages = [];

    const firebaseConfig = {
        apiKey: "AIzaSyCpzXbFwpeHOBprUTFnvxp-0NvSjlIeuRg",
        authDomain: "japa-269a4.firebaseapp.com",
        projectId: "japa-269a4",
        storageBucket: "japa-269a4.firebasestorage.app",
        messagingSenderId: "736749113389",
        appId: "1:736749113389:web:886266a10a7b32f5ae28a4"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);


    // Initialize Firebase Authentication and get a reference to the service
    const auth = firebase.auth();

    // Initialize Cloud Firestore and get a reference to the service
    const db = firebase.firestore();

    function myFirebaseUserAuth() {
        // Firebase Auth State Change Handler
        firebase.auth().onAuthStateChanged((user) => {
            const usernameElement = document.getElementById("username");

            if (user) {
                console.log("Current user:", user);

                // Get the first initial from display name or email
                const displayName = user.displayName || user.email;
                const firstInitial = displayName.charAt(0).toUpperCase();



                // Replace the button content with profile picture and dropdown
                usernameElement.innerHTML = `
                    <div class="user-profile-container">
        <div class="profile-picture" id="profilePicture">
            <span class="profile-initial">${firstInitial}</span>
        </div>
        <div class="profile-dropdown" id="profileDropdown">
            <div class="dropdown-header">
                <div class="dropdown-profile-pic">
                    <span class="dropdown-initial">${firstInitial}</span>
                </div>
                <div class="dropdown-user-info">
                    <div class="dropdown-name">üëãüèΩ Hello, there! ${user.displayName || 'Hello, there! üëãüèΩ'}</div>
                    <div class="dropdown-email">${user.email}</div>
                </div>
            </div>
            <hr class="dropdown-divider">
            <button class="dropdown-item" id="route-to-trips">
                <svg class="logout-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"
                        fill="currentColor" />
                </svg>
                My Upcoming Trips
            </button>
            <hr class="dropdown-divider">
            <button class="dropdown-item" id="bookmark-btn">
                <svg class="logout-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
                </svg>
                My Bookmarked Trips
            </button>
            <hr class="dropdown-divider">
            <button style = "color: red;" class="dropdown-item" id="logoutBtn">
                <svg class="logout-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="red" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" />
                    <polyline points="16,17 21,12 16,7" stroke="red" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <line x1="21" y1="12" x2="9" y2="12" stroke="red" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                Log Out
            </button>
        </div>
    </div>
    `;

                // Remove the login-button class and add user-profile class
                usernameElement.className = "user-profile";

            } else {
                console.log("No user signed in.");
                // Reset to login button
                usernameElement.innerHTML = '<a href="user-auth.html">Log In</a>';
                usernameElement.className = "login-button";
            }
        });

        // Toggle dropdown function
        function toggleDropdown() {
            const dropdown = document.getElementById("profileDropdown");
            dropdown.classList.toggle("show");
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const userProfile = document.querySelector('.user-profile-container');
            const dropdown = document.getElementById("profileDropdown");

            if (userProfile && !userProfile.contains(event.target)) {
                dropdown?.classList.remove("show");
            }
        });

        // Logout function with event listener
        function handleLogout() {
            firebase.auth().signOut().then(() => {
                console.log("User signed out successfully");
                // Redirect to home page or refresh
                window.location.reload();
            }).catch((error) => {
                console.error("Error signing out:", error);
            });
        }

        // Routing users to upcoming trips / booking history
        function handleUpcomingTripsRoute() {
            window.location.href = './bookinghistory.html'
        }

        // Routing users to bookmarks
        function handleBookmarks() {
            window.location.href = './favorite-travel-packages.html'
        }

        // Add event listener for logout button and profile picture
        document.addEventListener('DOMContentLoaded', function () {
            // Use event delegation since elements are dynamically created
            document.addEventListener('click', function (event) {
                // Handle logout button click
                if (event.target.closest('#logoutBtn')) {
                    handleLogout();
                }
                if (event.target.closest('#route-to-trips')) {
                    handleUpcomingTripsRoute();
                }
                if (event.target.closest('#bookmark-btn')) {
                    handleBookmarks();
                }

                // Handle profile picture click
                if (event.target.closest('#profilePicture')) {
                    toggleDropdown();
                }
            });
        });

    }
    myFirebaseUserAuth()

    // Show loading state initially
    function showLoading() {
        document.getElementById("bottom-container").innerHTML = `
        <div class="loading-container" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            z-index: 9999;
        ">
            <div class="airbnb-spinner" style="
                width: 48px; 
                height: 48px; 
                margin-bottom: 32px;
                position: relative;
            ">
                <div class="spinner-dot" style="
                    position: absolute;
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    background-color: #FF385C;
                    animation: airbnb-bounce 1.4s ease-in-out infinite both;
                "></div>
                <div class="spinner-dot" style="
                    position: absolute;
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    background-color: #FF385C;
                    animation: airbnb-bounce 1.4s ease-in-out infinite both;
                    animation-delay: -0.16s;
                    left: 18px;
                "></div>
                <div class="spinner-dot" style="
                    position: absolute;
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    background-color: #FF385C;
                    animation: airbnb-bounce 1.4s ease-in-out infinite both;
                    animation-delay: -0.32s;
                    left: 36px;
                "></div>
            </div>
            <p style="
                color: #222222; 
                font-size: 20px; 
                font-weight: 500; 
                margin: 0;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                text-align: center;
            ">Finding amazing places for you...</p>
        </div>
        <style>
            @keyframes airbnb-bounce {
                0%, 80%, 100% {
                    transform: scale(0);
                    opacity: 0.5;
                }
                40% {
                    transform: scale(1);
                    opacity: 1;
                }
            }
        </style>
    `;
    }    // Show loading state immediately
    showLoading();

    // Fetch data from Firebase
    db.collection("travel-packages").get()
        .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
                const packageData = doc.data();
                packageData.id = doc.id; // Save ID with data
                travelPackages.push(packageData);
            });

            console.log("All travel packages:", travelPackages);

            // Render only once after all data is loaded
            renderPackages(travelPackages);

            // Save to localStorage for quick access later
            // Note: Using localStorage instead of sessionStorage as in your original code
            localStorage.setItem("travelPackage", JSON.stringify(travelPackages));
        })
        .catch((error) => {
            console.error("Error getting documents: ", error);

            // Show error state
            document.getElementById("bottom-container").innerHTML = `
            <div class="error-container" style="text-align: center; padding: 40px;">
                <p style="color: #e74c3c; font-size: 16px;">Failed to load travel packages. Please try again.</p>
                <button onclick="location.reload()" style="margin-top: 10px; padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
            </div>
        `;
        });

    // Function to render packages
    function renderPackages(packages) {
        // Check if we have packages to render
        if (!packages || packages.length === 0) {
            document.getElementById("bottom-container").innerHTML = `
            <div class="no-packages" style="text-align: center; padding: 40px;">
                <p>No travel packages available at the moment.</p>
            </div>
        `;
            return;
        }

        // Mapping through the travelPackage database to render on the DOM
        const displayPackageHTML = packages.map((travelPkg, index) => {
            return `<div class="travel-package-card" id="pkgIndex-${index}" data-package-index="${index}">
            <img class="thumbnail" src="${travelPkg.categoryThumbnail}" alt="" srcset=""
                style="border-bottom-left-radius: 0px; border-bottom-right-radius: 0px;">
            <div class="content" style="padding-left: 16px; padding-right: 16px;">
                <div class="name-desc">
                    <h3 style="font-size: 18px; margin-bottom: -2px;">${travelPkg.categoryName}</h3>
                    <p style="font-size: 14px; font-weight: 400; color: var(--Subtext, rgba(27, 14, 6, 0.80)); line-height: 160%;">${travelPkg.description}</p>
                </div>
            </div>
        </div>`;
        });

        // Rendering travel packages in the DOM
        document.getElementById("bottom-container").innerHTML = displayPackageHTML.join('');

        // Add click event listeners to all package cards
        document.querySelectorAll('.travel-package-card').forEach(card => {
            card.addEventListener('click', function () {
                const packageIndex = this.getAttribute('data-package-index');
                routeToSubTravels(packageIndex);
            });
        });
    }

    // Function to route user to sub travel packages page
    function routeToSubTravels(packageIndex) {
        console.log("Selected package index:", packageIndex);
        console.log("Selected Package:", travelPackages[packageIndex]);
        window.location.href = `sub-travel-packages.html?packageId=${packageIndex}`;
    }

</script>

</html>